import org.apache.spark.sql.*;
import org.apache.spark.sql.api.java.UDF1;
import org.apache.spark.sql.types.*;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.nio.charset.StandardCharsets;
import java.util.*;

import static org.apache.spark.sql.functions.*;

public class EncryptJsonColumnWithEnum {
    public static void main(String[] args) {
        // Create SparkSession
        SparkSession spark = SparkSession.builder()
                .appName("Encrypt JSON Column with Enum")
                .master("local")
                .getOrCreate();

        // Sample dataset with a binary column containing JSON
        Dataset<Row> dataset = spark.createDataFrame(
                Arrays.asList(
                        RowFactory.create(1, "Alice", "{\"name\":\"Alice\",\"ssn\":\"123-45-6789\",\"email\":\"alice@example.com\"}".getBytes(StandardCharsets.UTF_8)),
                        RowFactory.create(2, "Bob", "{\"name\":\"Bob\",\"ssn\":\"987-65-4321\",\"phone\":\"1234567890\"}".getBytes(StandardCharsets.UTF_8))
                ),
                new StructType()
                        .add("ID", DataTypes.IntegerType)
                        .add("Name", DataTypes.StringType)
                        .add("JsonBinary", DataTypes.BinaryType) // Binary column containing JSON
        );

        // Register UDF to encrypt only PII fields
        spark.udf().register("encryptPiiFields", (byte[] binaryData) -> {
            if (binaryData == null) return null;

            try {
                // Convert binary data to JSON string
                String jsonString = new String(binaryData, StandardCharsets.UTF_8);

                // Parse JSON into a Map
                ObjectMapper objectMapper = new ObjectMapper();
                Map<String, Object> jsonMap = objectMapper.readValue(jsonString, HashMap.class);

                // Encrypt only PII fields
                for (Map.Entry<String, Object> entry : jsonMap.entrySet()) {
                    String key = entry.getKey();
                    if (PiiUtil.isPiiData(key) && entry.getValue() instanceof String) {
                        jsonMap.put(key, PiiUtil.encryptData((String) entry.getValue())); // Encrypt PII data
                    }
                }

                // Convert back to JSON string
                String updatedJson = objectMapper.writeValueAsString(jsonMap);

                // Convert JSON string back to byte array
                return updatedJson.getBytes(StandardCharsets.UTF_8);
            } catch (Exception e) {
                e.printStackTrace();
                return null;
            }
        }, DataTypes.BinaryType);

        // Apply UDF to update the binary column
        Dataset<Row> updatedDataset = dataset.withColumn(
                "JsonBinary",
                callUDF("encryptPiiFields", col("JsonBinary"))
        );

        // Show the result (decode binary for display)
        updatedDataset.withColumn(
                "JsonString",
                expr("CAST(JsonBinary AS STRING)") // Convert binary back to string for display
        ).show(false);

        // Stop SparkSession
        spark.stop();
    }
}
